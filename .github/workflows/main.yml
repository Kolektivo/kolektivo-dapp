name: main
on: [push]
jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "16"
          cache: "npm"
      - run: npm ci
      - run: npm run lint

  # deploy:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     DEPLOYMENT_URL: ${{ steps.vercel-deploy.outputs.PREVIEW_URL }}
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v2

  #     - name: Deploy to Vercel Action
  #       id: vercel-deploy
  #       uses: BetaHuhn/deploy-to-vercel-action@v1
  #       with:
  #         GITHUB_TOKEN: ${{ secrets.GH_PAT }}
  #         VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  #         VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  #         VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  #         PRODUCTION: false

  deploy:
    runs-on: ubuntu-latest
    outputs:
      DEPLOYMENT_URL: ${{ steps.vercel-deploy.outputs.PREVIEW_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Create .vercel directory
        run: |
          mkdir .vercel
          cd .vercel
          touch project.json
          echo '{"projectId":"${{ secrets.VERCEL_PROJECT_ID }}","orgId":"${{ secrets.VERCEL_ORG_ID }}"}' >> project.json
      - name: Deploy to Vercel
        id: vercel-deploy
        run: |
          npm i -g vercel
          vercel --token ${{ secrets.VERCEL_TOKEN }} > deployment-url.txt
          DEPLOYMENT_URL=(cat deployment-url.txt)
          echo $DEPLOYMENT_URL
          echo "::set-output name=PREVIEW_URL::$DEPLOYMENT_URL"

  cypress-run:
    needs: deploy
    name: Cypress run
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Cypress run
        uses: cypress-io/github-action@v4
        with:
          config: pageLoadTimeout=100000,baseUrl=${{needs.deploy.outputs.DEPLOYMENT_URL}}

  # alias-domain:
  #   needs: cypress-run
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: "16"
  #     - run: npm i -g vercel
